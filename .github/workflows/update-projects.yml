name: Update Published Projects

on:
  workflow_dispatch:

jobs:
  update-projects:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout blog repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.BLOG_TRIGGER_TOKEN }}
          fetch-depth: 0

      - name: Set up Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Download project metadata files
        run: |
          mkdir -p _projects
          gh repo list lucascarpantonio --json name,url,defaultBranchRef --limit 50 > repos.json
          for repo in $(jq -r '.[].name' repos.json); do
            if gh api repos/lucascarpantonio/$repo/branches/blog --silent >/dev/null 2>&1; then
              echo "Fetching metadata from $repo"
              gh api repos/lucascarpantonio/$repo/contents/metadata.yml?ref=blog \
                --jq '.content' | base64 --decode > _projects/${repo}.yml
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.BLOG_TRIGGER_TOKEN }}

      - name: Convert YAML metadata to Markdown
        run: |
          for yml in _projects/*.yml; do
            name=$(basename "$yml" .yml)
            title=$(yq '.project.title' "$yml")
            description=$(yq '.project.description' "$yml")
            url=$(yq '.project.url' "$yml")
            echo "---" > "_projects/${name}.md"
            echo "title: \"$title\"" >> "_projects/${name}.md"
            echo "url: $url" >> "_projects/${name}.md"
            echo "layout: project" >> "_projects/${name}.md"
            echo "---" >> "_projects/${name}.md"
            echo "" >> "_projects/${name}.md"
            echo "$description" >> "_projects/${name}.md"
            rm "$yml"
          done

      - name: Commit and push updates
        run: |
          git add _projects/
          if git diff --cached --quiet; then
            echo "No project updates found."
          else
            git commit -m "Auto-update published projects"
            git push origin main
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.BLOG_TRIGGER_TOKEN }}
name: Update Published Projects

on:
  workflow_dispatch:
  repository_dispatch:
    types: [update_project]
permissions:
  contents: write
  actions: read
  
jobs:
  update-projects:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup project metadata
        id: metadata
        run: |
          # Default fallback if payload is missing
          TITLE="${{ github.event.client_payload.title || 'Untitled Project' }}"
          REPO_URL="${{ github.event.client_payload.repo_url || 'https://github.com/' }}"
          DESCRIPTION="${{ github.event.client_payload.description || 'No description provided.' }}"
          TAGS="${{ github.event.client_payload.tags || 'python' }}"
          FILENAME=$(basename "${REPO_URL}")
          FILEPATH="_projects/${FILENAME}.md"

          echo "Creating markdown file for project: $TITLE"
          echo "Path: $FILEPATH"

          cat > "$FILEPATH" <<EOF
---
layout: project
title: "$TITLE"
url: "$REPO_URL"
description: "$DESCRIPTION"
tags: [${TAGS}]
---

$DESCRIPTION

ðŸ”— [View the repository on GitHub]($REPO_URL)
EOF

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add _projects/
          git commit -m "Add or update project metadata file"
          git push origin main

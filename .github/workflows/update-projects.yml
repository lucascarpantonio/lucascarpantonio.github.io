name: Update Projects from GitHub API

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-projects:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get repositories with topic 'showcase'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "🔍 Fetching repositories with topic 'showcase' via GitHub API..."
          USERNAME="lucascarpantonio"

          # Richiesta API REST — restituisce tutti i repo dell'utente
          curl -s -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github+json" \
               "https://api.github.com/users/$USERNAME/repos?per_page=100" \
            | jq -r '.[] | select(.topics | index("showcase")) | [.name, .html_url, .description, (.topics | join(","))] | @tsv' \
            > repos.tsv

          echo "Repositories found:"
          cat repos.tsv || echo "Nessun repository trovato con topic showcase"

      - name: Generate _projects entries
        run: |
          mkdir -p _projects

          while IFS=$'\t' read -r name url description topics; do
            [ -z "$name" ] && continue
            filename="_projects/${name}.md"
            echo "Creating $filename"
            
            desc_escaped=$(echo "$description" | sed 's/"/\\"/g')

            {
              echo "---"
              echo "layout: project"
              echo "title: \"$name\""
              echo "url: \"$url\""
              echo "description: \"$desc_escaped\""
              if [ -n "$topics" ]; then
                echo "tags: [${topics//,/ , }]"
              fi
              echo "---"
              echo ""
              echo "🔗 [View on GitHub]($url)"
            } > "$filename"

          done < repos.tsv

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add _projects

          if git diff --cached --quiet; then
            echo "No new projects to commit."
          else
            git commit -m "Update project list from GitHub API"
            git push origin main
          fi
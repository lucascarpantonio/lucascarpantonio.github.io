name: Update Projects from GitHub API

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-projects:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get repositories with topic 'showcase'
        run: |
          echo "Fetching repositories with topic 'showcase' for user lucascarpantonio..."
          USERNAME="lucascarpantonio"
          
          # Usa GitHub CLI per ottenere fino a 100 repo
          gh repo list $USERNAME --limit 100 --json name,description,htmlUrl,topics \
            --jq '.[] | select(.topics | index("showcase")) | [.name, .htmlUrl, .description, (.topics | join(","))] | @tsv' > repos.tsv

          echo "ðŸ“¦ Repositories found:"
          cat repos.tsv || echo "Nessun repository trovato con topic showcase"

      - name: Generate _projects entries
        run: |
          mkdir -p _projects

          while IFS=$'\t' read -r name url description topics; do
            [ -z "$name" ] && continue

            filename="_projects/${name}.md"
            echo "Creating $filename"

            # Escape doppie virgolette nel campo description
            desc_escaped=$(echo "$description" | sed 's/"/\\"/g')

            {
              echo "---"
              echo "layout: project"
              echo "title: \"$name\""
              echo "url: \"$url\""
              echo "description: \"$desc_escaped\""
              if [ -n "$topics" ]; then
                echo "tags: [${topics//,/ , }]"
              fi
              echo "---"
              echo ""
              echo "ðŸ”— [View on GitHub]($url)"
            } > "$filename"

          done < repos.tsv

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add _projects

          if git diff --cached --quiet; then
            echo "No new projects to commit."
          else
            git commit -m "Update project list from GitHub API"
            git push origin main
          fi
name: Update Projects from GitHub API

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-projects:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get repositories with topic 'showcase'
        id: repos
        run: |
          echo "Fetching repositories for user lucascarpantonio..."
          curl -s -H "Accept: application/vnd.github+json" \
            https://api.github.com/users/lucascarpantonio/repos?per_page=100 \
            | jq -r '.[] | select(.topics | index("showcase")) | [.name, .html_url, .description, (.topics | join(", "))] | @tsv' > repos.tsv

          cat repos.tsv

      - name: Generate _projects entries
        run: |
          mkdir -p _projects
          while IFS=$'\t' read -r name url description topics; do
            filename="_projects/${name}.md"
            echo "Creating $filename"
            cat <<'EOF' > "$filename"
---
layout: project
title: "${name}"
url: "${url}"
description: "${description}"
tags: [${topics}]
---

${description}

ðŸ”— [View repository on GitHub](${url})
EOF
          done < repos.tsv

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add _projects/
          if git diff --cached --quiet; then
            echo "âœ… No changes to commit."
          else
            git commit -m "Update project list from GitHub API"
            git push origin main
          fi
